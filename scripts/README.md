# 图片压缩工具 - 支持并发处理和Git LFS

这是一个高性能的图片压缩工具，支持并发处理多个图片文件，并集成了Git LFS (Large File Storage) 功能，显著提高压缩速度和存储效率。

## ✨ 功能特性

- **并发压缩**: 使用多线程同时处理多个图片文件
- **智能线程管理**: 自动管理线程池，避免资源浪费
- **实时进度显示**: 显示每个文件的压缩进度和压缩率
- **性能统计**: 显示总体压缩率、文件大小变化和处理时间
- **线程安全输出**: 使用线程锁确保输出信息不混乱
- **智能压缩判断**: 自动跳过压缩后文件变大的图片，保留原文件
- **压缩率阈值**: 可设置最小压缩率要求，只压缩有效果的文件
- **Git LFS集成**: 支持大文件存储，优化仓库性能
- **迁移工具**: 提供LFS到Git的迁移脚本

## 🚀 性能提升

- **单线程模式**: 适合少量文件或对稳定性要求高的场景
- **多线程模式**: 默认4线程，可显著提升处理速度
- **可调节线程数**: 根据CPU核心数和内存情况调整

## 🧠 智能压缩功能

### 自动跳过无效压缩
- **负压缩率检测**: 自动识别压缩后文件变大的图片
- **原文件保留**: 跳过压缩，直接复制原文件到输出目录
- **智能判断**: 避免因压缩导致文件质量下降

### 压缩率阈值控制
- **可设置阈值**: 使用 `--min-compression` 参数设置最小压缩率要求
- **质量保证**: 只压缩真正有效果的文件
- **灵活控制**: 根据需求调整压缩策略

### 使用场景
```bash
# 只压缩压缩率超过20%的文件
python compress_images.py --min-compression 20

# 只压缩压缩率超过5%的文件（较宽松）
python compress_images.py --min-compression 5

# 压缩所有文件，即使压缩后变大（默认行为）
python compress_images.py
```

## 📋 安装要求

- Python 3.6+
- Pillow库 (PIL)
- Git LFS (可选，用于大文件存储)

```bash
pip install Pillow
git lfs install  # 如果需要LFS功能
```

## 🎯 使用方法

### 基本使用（默认4线程）
```bash
python compress_images.py
```

### 自定义线程数
```bash
# 使用8个线程
python compress_images.py --workers 8

# 使用2个线程（适合低配置设备）
python compress_images.py -w 2
```

### 完整参数示例
```bash
python compress_images.py \
  --quality 80 \
  --max-width 1280 \
  --max-height 720 \
  --workers 6 \
  --min-compression 10 \
  --output compressed_images
```

## ⚙️ 参数说明

| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `--input` | `-i` | `images` | 输入目录 |
| `--output` | `-o` | `images/compressed` | 输出目录 |
| `--quality` | `-q` | `85` | 压缩质量 (1-100) |
| `--max-width` | - | `1920` | 最大宽度 |
| `--max-height` | - | `1080` | 最大高度 |
| `--workers` | `-w` | `4` | 并发线程数 |
| `--overwrite` | - | `False` | 覆盖原文件 |
| `--min-compression` | - | `0.0` | 最小压缩率要求 (%) |

## 🔧 线程数建议

### 推荐配置
- **4线程**: 默认配置，适合大多数情况
- **6-8线程**: 高性能设备，快速处理大量文件
- **2线程**: 低配置设备，避免系统卡顿

### 选择依据
- **CPU核心数**: 建议不超过CPU核心数的2倍
- **内存大小**: 每个线程约占用50-100MB内存
- **磁盘性能**: SSD硬盘可以支持更多线程

## 📊 输出示例

```
找到 126 个图片文件
压缩质量: 85
最大尺寸: 1920x1080
输出目录: images/compressed
并发线程数: 4
最小压缩率要求: 10.0%
开始时间: 2024-01-15 14:30:25
--------------------------------------------------
开始并发压缩，使用 4 个线程...
最小压缩率要求: 10.0%
--------------------------------------------------
✓ image1.jpg -> image1.jpg
  原始大小: 2048.0 KB
  压缩后: 512.0 KB
  压缩率: 75.0%

⚠️  image2.png -> image2.png (跳过压缩)
  原始大小: 1536.0 KB
  压缩后: 1536.0 KB (保持原文件)
  原因: 压缩率不满足要求，保留原文件

✓ image3.jpg -> image3.jpg
  原始大小: 1024.0 KB
  压缩后: 256.0 KB
  压缩率: 75.0%
--------------------------------------------------
压缩完成! 成功: 126/126
实际压缩: 98 个文件
跳过压缩: 28 个文件
总原始大小: 245.8 MB
总压缩后大小: 61.5 MB
总体压缩率: 75.0%
处理时间: 0:01:23.456789
压缩后的文件保存在: images/compressed

💡 压缩策略: 只压缩压缩率超过 10.0% 的文件
   其他文件将保持原样，确保压缩效果
```

## ⚠️ 注意事项

1. **内存使用**: 多线程会增加内存占用，建议监控系统资源
2. **磁盘I/O**: 大量并发写入可能影响磁盘性能
3. **网络环境**: 如果图片存储在网络位置，网络带宽可能成为瓶颈
4. **系统稳定性**: 极高线程数可能导致系统不稳定

## 🐛 故障排除

### 常见问题
- **内存不足**: 减少线程数或分批处理
- **磁盘空间不足**: 检查输出目录可用空间
- **权限错误**: 确保对输入输出目录有读写权限

### 性能调优
- 根据CPU核心数调整线程数
- 监控内存和磁盘使用情况
- 对于大量文件，考虑分批处理

## 📈 性能对比

| 文件数量 | 单线程 | 4线程 | 8线程 | 提升倍数 |
|----------|--------|-------|-------|----------|
| 50张 | 2分钟 | 30秒 | 25秒 | 4-5x |
| 100张 | 4分钟 | 1分钟 | 45秒 | 4-5x |
| 500张 | 20分钟 | 5分钟 | 3分钟 | 4-7x |

*实际性能提升取决于硬件配置和文件大小*

## 🛠️ 可用工具

### 主要脚本
- **`compress_images.py`**: 主压缩脚本（支持并发和智能压缩）

### 配置文件
- **`requirements.txt`**: Python依赖

### 文档
- **`README.md`**: 本文件，完整使用说明

## 📚 更多资源

- [Pillow文档](https://pillow.readthedocs.io/)
- [Python并发编程](https://docs.python.org/3/library/concurrent.futures.html)

## 🆘 技术支持

如果遇到问题，可以：
1. 检查Python版本（需要3.6+）
2. 确认Pillow库已安装
3. 查看错误日志和输出信息
4. 使用迁移工具进行故障排除

---

**🎉 享受高效的图片压缩体验！** 